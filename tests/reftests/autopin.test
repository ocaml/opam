N0REP0
### :::Autopin from install, with depext involved:::
### <pkg:foo-core.0.1>
opam-version: "2.0"
### <pkg:foo-format.0.1>
opam-version: "2.0"
### <pkg:ocaml.5>
opam-version: "2.0"
flags: compiler
### <pkg:base.1>
opam-version: "2.0"
### <pkg:buildy.1>
opam-version: "2.0"
### <pkg:devvy.1>
opam-version: "2.0"
### <pkg:other.1>
opam-version: "2.0"
### <pkg:foo-file-format.3>
opam-version: "2.0"
### <pkg:foo-file-format.2>
opam-version: "2.0"
### <pin:foo/foo-core.opam>
version: "2.0"
depends: [
 "ocaml"
 "base"
 "buildy" {build}
 "devvy" {dev}
]
conflicts: "conflicty"
### <pin:foo/foo-format.opam>
version: "2.0"
depends: [
  "ocaml"
  "foo-core" {=version}
  "foo-file-format"
  "other"
]
depexts: ["some-depext"]
### OPAMNODEPEXTS=0 OPAMCONFIRMLEVEL=unsafe-yes
### opam var --global os-family=dummy-success
Added '[os-family "dummy-success" "Set through 'opam var'"]' to field global-variables in global configuration
### opam switch create ./foo --deps-only | sed-cmd echo

<><> Installing new switch packages <><><><><><><><><><><><><><><><><><><><><><>
Switch invariant: ["ocaml" {>= "4.05.0"}]
The following actions will be performed:
=== install 6 packages
  - install base            1 [required by foo-core]
  - install buildy          1 [required by foo-core]
  - install devvy           1 [required by foo-core]
  - install foo-file-format 3 [required by foo-format]
  - install ocaml           5
  - install other           1 [required by foo-format]

The following system packages will first need to be installed:
    some-depext

<><> Handling external dependencies <><><><><><><><><><><><><><><><><><><><><><>

opam believes some required external dependencies are missing. opam can:
> 1. Run echo to install them (may need root/sudo access)
  2. Display the recommended echo command and wait while you run it manually (e.g. in another terminal)
  3. Continue anyway, and, upon success, permanently register that this external dependency is present, but not detectable
  4. Abort the installation

[1/2/3/4] 1

+ echo "some-depext"
- some-depext

<><> Processing actions <><><><><><><><><><><><><><><><><><><><><><><><><><><><>
-> installed base.1
-> installed buildy.1
-> installed devvy.1
-> installed foo-file-format.3
-> installed ocaml.5
-> installed other.1
Done.
### opam pin --switch=./foo
### opam list --switch=./foo
# Packages matching: installed
# Name          # Installed # Synopsis
base            1
buildy          1
devvy           1
foo-file-format 3
ocaml           5
other           1
### opam switch remove ./foo
Switch ${BASEDIR}/foo and all its packages will be wiped. Are you sure? [Y/n] y
### opam switch create fooism --empty
### opam install ./foo --deps-only | sed-cmd echo
The following actions will be performed:
=== install 6 packages
  - install base            1 [required by foo-core]
  - install buildy          1 [required by foo-core]
  - install devvy           1 [required by foo-core]
  - install foo-file-format 3 [required by foo-format]
  - install ocaml           5 [required by foo-core, foo-format]
  - install other           1 [required by foo-format]

The following system packages will first need to be installed:
    some-depext

<><> Handling external dependencies <><><><><><><><><><><><><><><><><><><><><><>

opam believes some required external dependencies are missing. opam can:
> 1. Run echo to install them (may need root/sudo access)
  2. Display the recommended echo command and wait while you run it manually (e.g. in another terminal)
  3. Continue anyway, and, upon success, permanently register that this external dependency is present, but not detectable
  4. Abort the installation

[1/2/3/4] 1

+ echo "some-depext"
- some-depext

<><> Processing actions <><><><><><><><><><><><><><><><><><><><><><><><><><><><>
-> installed base.1
-> installed buildy.1
-> installed devvy.1
-> installed foo-file-format.3
-> installed ocaml.5
-> installed other.1
Done.
### opam pin
### opam list
# Packages matching: installed
# Name          # Installed # Synopsis
base            1
buildy          1
devvy           1
foo-file-format 3
ocaml           5
other           1
### opam install ./foo foo-file-format.2 | sed-cmd echo
foo-format is now pinned to file://${BASEDIR}/foo (version 2.0)
foo-core is now pinned to file://${BASEDIR}/foo (version 2.0)
The following actions will be performed:
=== downgrade 1 package
  - downgrade foo-file-format 3 to 2
=== install 2 packages
  - install   foo-core        2.0 (pinned)
  - install   foo-format      2.0 (pinned)

The following system packages will first need to be installed:
    some-depext

<><> Handling external dependencies <><><><><><><><><><><><><><><><><><><><><><>

opam believes some required external dependencies are missing. opam can:
> 1. Run echo to install them (may need root/sudo access)
  2. Display the recommended echo command and wait while you run it manually (e.g. in another terminal)
  3. Continue anyway, and, upon success, permanently register that this external dependency is present, but not detectable
  4. Abort the installation

[1/2/3/4] 1

+ echo "some-depext"
- some-depext

<><> Processing actions <><><><><><><><><><><><><><><><><><><><><><><><><><><><>
-> retrieved foo-core.2.0  (file://${BASEDIR}/foo)
-> removed   foo-file-format.3
-> installed foo-core.2.0
-> installed foo-file-format.2
-> retrieved foo-format.2.0  (file://${BASEDIR}/foo)
-> installed foo-format.2.0
Done.
### <pin:foo/foo-format-bis.opam>
version: "2.0"
depends: [
  "ocaml"
  "foo-core" {=version}
  "foo-file-format" {>= "3"}
  "other"
]
### opam install ./foo --deps-only --show
[WARNING] Opam package foo-format.2.0 depends on the following system package that can no longer be found: some-depext
The following actions would be performed:
=== recompile 1 package
  - recompile foo-format      2.0 (pinned) [uses foo-file-format]
=== upgrade 1 package
  - upgrade   foo-file-format 2 to 3       [required by foo-format, foo-format-bis]

The following system packages will first need to be installed:
    some-depext
### opam install ./foo --deps-only | sed-cmd echo
[WARNING] Opam package foo-format.2.0 depends on the following system package that can no longer be found: some-depext
The following actions will be performed:
=== recompile 1 package
  - recompile foo-format      2.0 (pinned) [uses foo-file-format]
=== upgrade 1 package
  - upgrade   foo-file-format 2 to 3       [required by foo-format, foo-format-bis]

The following system packages will first need to be installed:
    some-depext

<><> Handling external dependencies <><><><><><><><><><><><><><><><><><><><><><>

opam believes some required external dependencies are missing. opam can:
> 1. Run echo to install them (may need root/sudo access)
  2. Display the recommended echo command and wait while you run it manually (e.g. in another terminal)
  3. Continue anyway, and, upon success, permanently register that this external dependency is present, but not detectable
  4. Abort the installation

[1/2/3/4] 1

+ echo "some-depext"
- some-depext

<><> Processing actions <><><><><><><><><><><><><><><><><><><><><><><><><><><><>
-> removed   foo-format.2.0
-> removed   foo-file-format.2
-> installed foo-file-format.3
-> installed foo-format.2.0
Done.
### opam list
# Packages matching: installed
# Name          # Installed # Synopsis
base            1
buildy          1
devvy           1
foo-core        2.0         pinned to version 2.0 at file://${BASEDIR}/foo
foo-file-format 3
foo-format      2.0         pinned to version 2.0 at file://${BASEDIR}/foo
ocaml           5
other           1
### opam pin
foo-core.2.0      rsync  file://${BASEDIR}/foo
foo-format.2.0    rsync  file://${BASEDIR}/foo
### opam install ./foo --depext-only | sed-cmd echo
[WARNING] Opam package foo-format.2.0 depends on the following system package that can no longer be found: some-depext
[NOTE] Package foo-core is already installed (current version is 2.0).

The following system packages will first need to be installed:
    some-depext

<><> Handling external dependencies <><><><><><><><><><><><><><><><><><><><><><>

+ echo "some-depext"
- some-depext
### opam remove foo-format | grep -v import
[WARNING] Opam package foo-format.2.0 depends on the following system package that can no longer be found: some-depext
The following actions will be performed:
=== remove 1 package
  - remove foo-format 2.0 (pinned)

<><> Processing actions <><><><><><><><><><><><><><><><><><><><><><><><><><><><>
-> removed   foo-format.2.0
Done.
### opam pin -n ./foo
This will pin the following packages: foo-core, foo-format-bis, foo-format. Continue? [Y/n] y
[NOTE] Package foo-core is already pinned to file://${BASEDIR}/foo (version 2.0).
foo-core is now pinned to file://${BASEDIR}/foo (version 2.0)
[NOTE] Package foo-format-bis does not exist in opam repositories registered in the current switch.
foo-format-bis is now pinned to file://${BASEDIR}/foo (version 2.0)
[NOTE] Package foo-format is already pinned to file://${BASEDIR}/foo (version 2.0).
foo-format is now pinned to file://${BASEDIR}/foo (version 2.0)
### opam install ./foo --deps-only --show

The following system packages will first need to be installed:
    some-depext
Nothing to do.
### opam install ./foo --deps-only --dry-run

The following system packages will first need to be installed:
    some-depext

<><> Handling external dependencies <><><><><><><><><><><><><><><><><><><><><><>

opam believes some required external dependencies are missing. opam can:
> 1. Run echo to install them (may need root/sudo access)
  2. Display the recommended echo command and wait while you run it manually (e.g. in another terminal)
  3. Continue anyway, and, upon success, permanently register that this external dependency is present, but not detectable
  4. Abort the installation

[1/2/3/4] 1

Nothing to do.
### opam install ./foo --show
[NOTE] Package foo-core is already installed (current version is 2.0).
The following actions would be performed:
=== install 2 packages
  - install foo-format     2.0 (pinned)
  - install foo-format-bis 2.0 (pinned)

The following system packages will first need to be installed:
    some-depext
### opam install ./foo --depext-only --show
[NOTE] Package foo-core is already installed (current version is 2.0).

The following system packages will first need to be installed:
    some-depext
### opam install ./foo --deps-only | sed-cmd echo

The following system packages will first need to be installed:
    some-depext

<><> Handling external dependencies <><><><><><><><><><><><><><><><><><><><><><>

opam believes some required external dependencies are missing. opam can:
> 1. Run echo to install them (may need root/sudo access)
  2. Display the recommended echo command and wait while you run it manually (e.g. in another terminal)
  3. Continue anyway, and, upon success, permanently register that this external dependency is present, but not detectable
  4. Abort the installation

[1/2/3/4] 1

+ echo "some-depext"
- some-depext
Nothing to do.
### : Make sure pin-depends are installed when using "opam install --deps-only"
### opam switch create pin-deps --empty
### <pin:pin-dep/opam>
opam-version: "2.0"
### <pin:local-with-pin-deps/opam>
opam-version: "2.0"
depends: "pin-dep"
### <add-pin-depends.sh>
basedir=$(printf '%s' "$BASEDIR" | sed 's/\\/\\\\/g')
cat >> local-with-pin-deps/opam << EOF
pin-depends: ["pin-dep.dev" "file://$basedir/pin-dep"]
EOF
### sh add-pin-depends.sh
### opam install --show ./local-with-pin-deps
[ERROR] Package conflict!
  * Missing dependency:
    - local-with-pin-deps -> pin-dep
    unknown package

No solution found, exiting
# Return code 20 #
### opam pin
### opam install --dry-run ./local-with-pin-deps
[ERROR] Package conflict!
  * Missing dependency:
    - local-with-pin-deps -> pin-dep
    unknown package

No solution found, exiting
# Return code 20 #
### opam pin
### opam install --deps-only ./local-with-pin-deps
The following additional pinnings are required by local-with-pin-deps.dev:
  - pin-dep.dev at file://${BASEDIR}/pin-dep
Pin and install them? [Y/n] y
[NOTE] Package pin-dep does not exist in opam repositories registered in the current switch.
[pin-dep.dev] synchronised (no changes)
pin-dep is now pinned to file://${BASEDIR}/pin-dep (version dev)
The following actions will be performed:
=== install 1 package
  - install pin-dep dev (pinned) [required by local-with-pin-deps]

<><> Processing actions <><><><><><><><><><><><><><><><><><><><><><><><><><><><>
-> retrieved pin-dep.dev  (file://${BASEDIR}/pin-dep)
-> installed pin-dep.dev
Done.
### opam pin
pin-dep.dev    rsync  file://${BASEDIR}/pin-dep
### opam pin remove pin-dep
Ok, pin-dep is no longer pinned to file://${BASEDIR}/pin-dep (version dev)
The following actions will be performed:
=== remove 1 package
  - remove pin-dep dev

<><> Processing actions <><><><><><><><><><><><><><><><><><><><><><><><><><><><>
-> removed   pin-dep.dev
Done.
### opam pin
### opam install ./local-with-pin-deps
[NOTE] Package local-with-pin-deps does not exist in opam repositories registered in the current switch.
The following additional pinnings are required by local-with-pin-deps.dev:
  - pin-dep.dev at file://${BASEDIR}/pin-dep
Pin and install them? [Y/n] y
[NOTE] Package pin-dep does not exist in opam repositories registered in the current switch.
[pin-dep.dev] synchronised (no changes)
pin-dep is now pinned to file://${BASEDIR}/pin-dep (version dev)
local-with-pin-deps is now pinned to file://${BASEDIR}/local-with-pin-deps (version dev)
The following actions will be performed:
=== install 2 packages
  - install local-with-pin-deps dev (pinned)
  - install pin-dep             dev (pinned) [required by local-with-pin-deps]

<><> Processing actions <><><><><><><><><><><><><><><><><><><><><><><><><><><><>
-> retrieved local-with-pin-deps.dev  (file://${BASEDIR}/local-with-pin-deps)
-> retrieved pin-dep.dev  (file://${BASEDIR}/pin-dep)
-> installed pin-dep.dev
-> installed local-with-pin-deps.dev
Done.
### opam pin
local-with-pin-deps.dev    rsync  file://${BASEDIR}/local-with-pin-deps
pin-dep.dev                rsync  file://${BASEDIR}/pin-dep
